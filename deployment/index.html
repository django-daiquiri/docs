<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Deployment - Daiquiri documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Deployment";
        var mkdocs_page_input_path = "deployment.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Daiquiri documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Deployment</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#web-server">Web server</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#static-assets">Static assets</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#asyncronous-workers">Asyncronous workers</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#caching">Caching</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../administration/">Administration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../management/">Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../advanced/">Advanced features</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Daiquiri documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Deployment</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="deployment">Deployment</h1>
<h3 id="configuration">Configuration</h3>
<p>In production, you should create a dedicated user for your Daiquiri application. All steps for the installation, which do not need root access, should be done using this user. As before, we assume this user is called <code>daiquiri</code> and it&rsquo;s home is <code>/srv/daiquiri</code> and therefore your <code>app</code> is located in <code>/srv/daiquiri/app</code>.</p>
<p>In addition, a few more settings need to be configured in your <code>.env</code> file. The most important change is to set <code>DEBUG=False</code>.</p>
<pre><code>DEBUG=False
ALLOWED_HOSTS=&lt;hostname&gt;

# ADMINS will get E-Mails in case of an error
ADMINS=Anna Admin &lt;admin@example.com&gt;, Manni Manager &lt;manager@example.com&gt;

LOG_DIR=/var/log/django/daiquiri
</code></pre>
<h3 id="web-server">Web server</h3>
<p>Daiquiri can be run in different configurations, both with <a href="https://httpd.apache.org/">Apache2</a> and <a href="https://www.nginx.com/">NGINX</a> as web server. Daiquiri itself is using the <a href="https://docs.djangoproject.com/en/stable/howto/deployment/wsgi/">wsgi</a> protocol for the communication between the HTTP and the Python layer. The recommended way of deploying Daiquiri is using <a href="https://httpd.apache.org/">Apache2</a> as a reverse proxy and <a href="https://gunicorn.org/">Gunicorn</a> as <a href="https://docs.djangoproject.com/en/stable/howto/deployment/wsgi/">wsgi</a> server.</p>
<p>For this setup, you need to add:</p>
<pre><code>PROXY=True
</code></pre>
<p>to your <code>.env</code> file.</p>
<p>First install Gunicorn inside your virtual environment:</p>
<pre><code class="language-bash">pip install gunicorn
</code></pre>
<p>Then, test <code>gunicorn</code> using:</p>
<pre><code class="language-bash">gunicorn --bind 0.0.0.0:8000 config.wsgi:application
</code></pre>
<p>This should serve the application like <code>runserver</code>, but without the static assets, like CSS files and images. After the test kill the <code>gunicorn</code> process again.</p>
<p>Systemd will launch the <code>gunicorn</code> process on startup and keep running. In order to start/restart/stop the web application as well as the asyncronous workers with one command, first create a pseudo-service for your Daiquiri application by creating the file <code>/etc/systemd/system/daiquiri.service</code> (you will need root/sudo permissions for that):</p>
<pre><code class="language-bash">[Unit]
Description=pseudo-service for all Daiquiri services

[Service]
Type=oneshot
ExecStart=/bin/true
RemainAfterExit=yes

[Install]
WantedBy=network.target
</code></pre>
<p>Then create the systemd service file for the actual web application in <code>/etc/systemd/system/daiquiri-app.service</code>:</p>
<pre><code>[Unit]
Description=Daiquiri gunicorn daemon
PartOf=daiquiri.service
After=daiquiri.service

[Service]
User=daiquiri
Group=daiquiri

WorkingDirectory=/srv/daiquiri/app
EnvironmentFile=/srv/daiquiri/app/.env

Environment=GUNICORN_BIN=/srv/daiquiri/app/env/bin/gunicorn
Environment=GUNICORN_WORKER=5
Environment=GUNICORN_PORT=9000
Environment=GUNICORN_TIMEOUT=120
Environment=GUNICORN_PID_FILE=/var/run/gunicorn/daiquiri/pid
Environment=GUNICORN_ACCESS_LOG_FILE=/var/log/gunicorn/daiquiri/access.log
Environment=GUNICORN_ERROR_LOG_FILE=/var/log/gunicorn/daiquiri/error.log

ExecStart=/bin/sh -c '${GUNICORN_BIN} \
  --workers ${GUNICORN_WORKER} \
  --pid ${GUNICORN_PID_FILE} \
  --bind localhost:${GUNICORN_PORT} \
  --timeout ${GUNICORN_TIMEOUT} \
  --access-logfile ${GUNICORN_ACCESS_LOG_FILE} \
  --error-logfile ${GUNICORN_ERROR_LOG_FILE} \
  config.wsgi:application'

ExecReload=/bin/sh -c '/usr/bin/pkill -HUP -F ${GUNICORN_PID_FILE}'

ExecStop=/bin/sh -c '/usr/bin/pkill -TERM -F ${GUNICORN_PID_FILE}'

[Install]
WantedBy=daiquiri.target
</code></pre>
<p>The setup needs to have several directories for logfiles set up with the correct permissions. This can be done using <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html">tmpfiles.d</a>. First, create a file <code>/etc/tmpfiles.d/daiquiri.conf</code>:</p>
<pre><code>d /run/celery/daiquiri        750 daiquiri daiquiri
d /run/gunicorn/daiquiri      750 daiquiri daiquiri

d /var/log/django/daiquiri    750 daiquiri daiquiri
d /var/log/celery/daiquiri    750 daiquiri daiquiri
d /var/log/gunicorn/daiquiri  755 daiquiri daiquiri
</code></pre>
<p>Then run:</p>
<pre><code class="language-bash">systemd-tmpfiles --create
</code></pre>
<p>The <code>daiquiri</code> systemd service needs to be started and enabled like any other service:</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl start daiquiri
sudo systemctl enable daiquiri
</code></pre>
<p>Next, install the web server. On Debian/Ubuntu use:</p>
<pre><code class="language-bash">sudo apt install apache2 libapache2-mod-xsendfile

sudo a2enmod proxy
sudo a2enmod remoteip
sudo a2enmod headers
</code></pre>
<p>and on CentOS 7/8 use</p>
<pre><code class="language-bash">sudo yum install httpd mod_xsendfile
</code></pre>
<p>Then, edit the virtual host configuration to create a reverse proxy to the Gunicorn server:</p>
<pre><code># in /etc/apache2/sites-available/000-default.conf  on Debian/Ubuntu
# in /etc/httpd/conf.d/vhost.conf                   on RHEL/CentOS
&lt;VirtualHost *:80&gt;
    ...

    DocumentRoot &quot;/var/www/html&quot;

    XSendFile on
    XSendFilePath &lt;FILES_BASE_PATH from the Daiquiri settings&gt;
    XSendFilePath &lt;QUERY_DOWNLOAD_PATH from the Daiquiri settings&gt;

    RequestHeader set X-Forwarded-Proto 'https' env=HTTPS

    ProxyPass /static !
    ProxyPass /cms !
    ProxyPass / http://localhost:9000/
    ProxyPassReverse /dev http://localhost:9000/

    Alias /static/ /srv/daiquiri/app/static_root/
    &lt;Directory /srv/daiquiri/app/static_root/&gt;
        Require all granted
    &lt;/Directory&gt;

    # if you intent to use the WordPress integration
    Alias /cms/ /opt/wordpress/
    &lt;Directory /opt/wordpress/&gt;
        AllowOverride all
        Require all granted
    &lt;/Directory&gt;
    &lt;Location /cms/wp-json/&gt;
        Deny from  all
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</code></pre>
<p>On CentOS <code>selinux</code> needs to be set to persive (or configured properly):</p>
<pre><code class="language-bash">setenforce permissive
</code></pre>
<p>Start the Apache server:</p>
<pre><code class="language-bash">sudo systemctl restart apache2  # on Debian/Ubuntu
sudo systemctl restart httpd    # on RHEL/CentOS
</code></pre>
<p>Your Daiquiri app should now be available on the configured virtual host, but again, without the static assets, like CSS files and images.</p>
<h3 id="static-assets">Static assets</h3>
<p>As you can see from the virtual host configurations, the static assets such as CSS and JavaScript files are served independently from the WSGI-python script. In order to do so, they need to be gathered in the <code>static_root</code> directory. This can be achieved by running:</p>
<pre><code class="language-bash">python manage.py collectstatic
</code></pre>
<p>in your virtual environment. The Apache user needs to have read permissions to <code>/srv/daiquiri/app/static_root/</code>.</p>
<p>In order to apply changes to the code, the <code>daiquiri-app</code> job needs to be reloaded.</p>
<h3 id="asyncronous-workers">Asyncronous workers</h3>
<p>In production, and especially if you intent to run several Daiquiri applications on the same RabbitMQ instance, it is recomended to use <a href="https://www.rabbitmq.com/vhosts.html">virtual hosts</a> and users with RabbitMQ. In order to create a virtual host and a user use the following commands on your RabbitMQ host:</p>
<pre><code class="language-bash"># first enable the managemetn interface and crate an admin user
rabbitmq-plugins enable rabbitmq_management
rabbitmqctl add_user admin &lt;a secret password&gt;
rabbitmqctl set_user_tags admin administrator

# then create a vhost and a user for your daiquiri app
rabbitmqctl add_vhost &lt;vhost&gt;
rabbitmqctl add_user &lt;user&gt; &lt;a secret password&gt;
rabbitmqctl set_permissions -p &lt;user&gt; &lt;user&gt; &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;
rabbitmqctl set_permissions -p &lt;user&gt; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;
</code></pre>
<p>Then add <code>CELERY_BROKER_URL</code> to the <code>.env</code> file of your Daiquiri application:</p>
<pre><code class="language-bash">CELERY_BROKER_URL=amqp://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;vhost&gt;
</code></pre>
<p>As with the Gunicorn process, the asyncronous workers are also using systemd to launch and keep running. Create the following service files for the three workers:</p>
<pre><code># in /etc/systemd/system/daiquiri-default-worker.service
[Unit]
Description=celery worker for the default queue
PartOf=daiquiri.service
After=daiquiri.service

[Service]
Type=forking
User=daiquiri
Group=daiquiri

WorkingDirectory=/srv/daiquiri/app
EnvironmentFile=/srv/daiquiri/app/.env

Environment=CELERY_BIN=/srv/daiquiri/app/env/bin/celery
Environment=CELERYD_NODE=daiquiri_default
Environment=CELERYD_QUEUE=default
Environment=CELERYD_CONCURRENCY=1
Environment=CELERYD_PID_FILE=/var/run/celery/daiquiri/default.pid
Environment=CELERYD_LOG_FILE=/var/log/celery/daiquiri/default.log
Environment=CELERYD_LOG_LEVEL=INFO

ExecStart=/bin/sh -c '${CELERY_BIN} multi start ${CELERYD_NODE} \
  -A config \
  -Q ${CELERYD_QUEUE} \
  -c ${CELERYD_CONCURRENCY} \
  --pidfile=${CELERYD_PID_FILE} \
  --logfile=${CELERYD_LOG_FILE} \
  --loglevel=${CELERYD_LOG_LEVEL}'

ExecStop=/bin/sh -c '${CELERY_BIN} multi stopwait ${CELERYD_NODE} \
  --pidfile=${CELERYD_PID_FILE}'

ExecReload=/bin/sh -c '${CELERY_BIN} multi restart ${CELERYD_NODE} \
  -A config \
  -Q ${CELERYD_QUEUE} \
  -c ${ELERYD_CONCURRENCY} \
  --pidfile=${CELERYD_PID_FILE} \
  --logfile=${CELERYD_LOG_FILE} \
  --loglevel=${CELERYD_LOG_LEVEL}'

[Install]
WantedBy=daiquiri.service
</code></pre>
<pre><code># in /etc/systemd/system/daiquiri-query-worker.service
[Unit]
Description=celery worker for the query queue
PartOf=daiquiri.service
After=daiquiri.service

[Service]
Type=forking
User=daiquiri
Group=daiquiri

WorkingDirectory=/srv/daiquiri/app
EnvironmentFile=/srv/daiquiri/app/.env

Environment=CELERY_BIN=/srv/daiquiri/app/env/bin/celery
Environment=CELERYD_NODE=daiquiri_query
Environment=CELERYD_QUEUE=query
Environment=CELERYD_CONCURRENCY=1
Environment=CELERYD_PID_FILE=/var/run/celery/daiquiri/query.pid
Environment=CELERYD_LOG_FILE=/var/log/celery/daiquiri/query.log
Environment=CELERYD_LOG_LEVEL=INFO

ExecStart=/bin/sh -c '${CELERY_BIN} multi start ${CELERYD_NODE} \
  -A config \
  -Q ${CELERYD_QUEUE} \
  -c ${CELERYD_CONCURRENCY} \
  --pidfile=${CELERYD_PID_FILE} \
  --logfile=${CELERYD_LOG_FILE} \
  --loglevel=${CELERYD_LOG_LEVEL}'

ExecStop=/bin/sh -c '${CELERY_BIN} multi stopwait ${CELERYD_NODE} \
  --pidfile=${CELERYD_PID_FILE}'

ExecReload=/bin/sh -c '${CELERY_BIN} multi restart ${CELERYD_NODE} \
  -A config \
  -Q ${CELERYD_QUEUE} \
  -c ${ELERYD_CONCURRENCY} \
  --pidfile=${CELERYD_PID_FILE} \
  --logfile=${CELERYD_LOG_FILE} \
  --loglevel=${CELERYD_LOG_LEVEL}'

[Install]
WantedBy=daiquiri.service
</code></pre>
<pre><code># in /etc/systemd/system/daiquiri-download-worker.service
[Unit]
Description=celery worker for the download queue
PartOf=daiquiri.service
After=daiquiri.service

[Service]
Type=forking
User=daiquiri
Group=daiquiri

WorkingDirectory=/srv/daiquiri/app
EnvironmentFile=/srv/daiquiri/app/.env

Environment=CELERY_BIN=/srv/daiquiri/app/env/bin/celery
Environment=CELERYD_NODE=daiquiri_download
Environment=CELERYD_QUEUE=download
Environment=CELERYD_CONCURRENCY=1
Environment=CELERYD_PID_FILE=/var/run/celery/daiquiri/download.pid
Environment=CELERYD_LOG_FILE=/var/log/celery/daiquiri/download.log
Environment=CELERYD_LOG_LEVEL=INFO

ExecStart=/bin/sh -c '${CELERY_BIN} multi start ${CELERYD_NODE} \
  -A config \
  -Q ${CELERYD_QUEUE} \
  -c ${CELERYD_CONCURRENCY} \
  --pidfile=${CELERYD_PID_FILE} \
  --logfile=${CELERYD_LOG_FILE} \
  --loglevel=${CELERYD_LOG_LEVEL}'

ExecStop=/bin/sh -c '${CELERY_BIN} multi stopwait ${CELERYD_NODE} \
  --pidfile=${CELERYD_PID_FILE}'

ExecReload=/bin/sh -c '${CELERY_BIN} multi restart ${CELERYD_NODE} \
  -A config \
  -Q ${CELERYD_QUEUE} \
  -c ${CELERYD_CONCURRENCY} \
  --pidfile=${CELERYD_PID_FILE} \
  --logfile=${CELERYD_LOG_FILE} \
  --loglevel=${CELERYD_LOG_LEVEL}'

[Install]
WantedBy=daiquiri.service
</code></pre>
<p>Then, the worker can be started and enabled as before:</p>
<pre><code class="language-bash">sudo systemctl daemon-reload

sudo systemctl start daiquiri-default-worker
sudo systemctl start daiquiri-query-worker
sudo systemctl start daiquiri-download-worker

sudo systemctl enable daiquiri-default-worker
sudo systemctl enable daiquiri-query-worker
sudo systemctl enable daiquiri-download-worker
</code></pre>
<h2 id="caching">Caching</h2>
<p>To use <a href="https://memcached.org/">memcached</a> as cache, first install it from the distribution:</p>
<pre><code class="language-bash">apt install memcached  # Debian/Ubuntu
yum install memcached  # CentOS
</code></pre>
<p>On CentOS memcached needs to be restricted to listen only to localhost in <code>/etc/sysconfig/memcached</code>:</p>
<pre><code>PORT=&quot;11211&quot;
USER=&quot;memcached&quot;
MAXCONN=&quot;1024&quot;
CACHESIZE=&quot;64&quot;
OPTIONS=&quot;-l 127.0.0.1,::1&quot;
</code></pre>
<p>Then memcached can be enabled and started:</p>
<pre><code class="language-bash">systemctl start memcached
systemctl enable memcached
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../installation/" class="btn btn-neutral float-left" title="Installation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../settings/" class="btn btn-neutral float-right" title="Settings">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../installation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../settings/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

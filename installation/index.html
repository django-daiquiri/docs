<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Installation - Daiquiri documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Installation";
        var mkdocs_page_input_path = "installation.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Daiquiri documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Installation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#installation-with-dq-dev">Installation with dq-dev</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#outdated-installation-notes">Outdated installation notes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#obtaining-the-app-directory">Obtaining the app directory</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#install-python-packages">Install Python packages</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#basic-setup">Basic setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#databases">Databases</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#initialization">Initialization</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#asyncronous-tasks">Asyncronous tasks</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deployment/">Deployment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../administration/">Administration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../management/">Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../advanced/">Advanced features</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../oai-metadata/">OAI Metadata</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Daiquiri documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Installation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="installation">Installation</h1>
<h2 id="installation-with-dq-dev">Installation with <code>dq-dev</code></h2>
<ul>
<li>Clone <code>dq-dev</code> and the default daiquiri-app</li>
</ul>
<pre><code class="language-bash">git clone https://github.com/django-daiquiri/app.git
git clone https://github.com/django-daiquiri/dq-dev.git
</code></pre>
<ul>
<li>Install <code>dq-dev</code> packages</li>
</ul>
<pre><code class="language-bash">cd dq-dev
pip install .
</code></pre>
<ul>
<li>Create new profile in <code>dq-dev</code> and then activate it</li>
</ul>
<pre><code class="language-bash">python manage.py -c myapp
python manage.py -s myapp
</code></pre>
<ul>
<li>Set the absolute path to the default app on your system in <code>dq-dev/usr/profiles/myapp/conf.toml</code></li>
</ul>
<pre><code class="language-toml">[folders_on_host]
dq_app = '/path/to/the/default/app'
</code></pre>
<p>The other <code>dq_app</code> variable should remain untouched</p>
<pre><code class="language-toml">[docker_volume_mountpoints]
dq_app = &quot;/home/dq/app&quot;
</code></pre>
<p><em>Important</em>: Make sure that all <code>dq_source</code> variables in <code>conf.toml</code> are commented out.</p>
<ul>
<li>Run dq-dev containerization in the dq-dev folder</li>
</ul>
<pre><code class="language-bash">python manage.py  -r
</code></pre>
<ul>
<li>Wait until the containers are up and running. Then you can access the default app at <code>http://localhost:9280</code></li>
</ul>
<p>If you run into any problems, don&rsquo;t hesitate to write an issue for <code>dq-dev</code> (https://github.com/django-daiquiri/dq-dev/issues)</p>
<p><strong>The installation procedure below might be outdated and will be updated soon. Currently,
we are using our containerization setup &lsquo;dq-dev&rsquo; which simplifies things 
quiet a bit.</strong></p>
<h2 id="outdated-installation-notes">Outdated installation notes</h2>
<p>A usual installation of Daiquiri contains of a set of different components:</p>
<ol>
<li>A <strong>directory</strong> holding all the settings and customisations, custom to your
installation of Daiquiri. We will call this directory <code>app</code>, but you can use
any name you see fit. This <code>app</code> directory corresponds to a
<a href="https://docs.djangoproject.com/en/stable/intro/tutorial01">project</a>
in Django terms.</li>
<li>The <code>django-daiquiri</code> <strong>library</strong>, which is centrally maintained,
and which is installed as a packacge using <code>pip</code>.</li>
<li>The <strong>application database</strong> to store the content, which is generated by
the users of your Daiquiri installation. Currently, we support PostgreSQL
and MySQL (deprecated).</li>
<li>A (bigger) <strong>scientific database</strong>, where the actual science data is stored.
This can be PostgreSQL and MySQL (deprecated).</li>
<li>A directory on your filesystem with static <strong>files</strong> to be downloaded.</li>
<li>A RabbitMQ installation as <strong>message broker</strong> for the asyncronous queues.</li>
</ol>
<p>For testing and development, you can run Daiquiri using your regular user
account. On a production system, a dedicated user account should be used.
For this documentation we will use a user called <code>daiquiri</code> with the
group <code>daiquiri</code> and the home directory <code>/srv/daiquiri</code>.
This user can be created with:</p>
<pre><code class="language-bash">useradd -m -d /srv/daiquiri -c &quot;Daiquiri user&quot; -s /bin/bash daiquiri
</code></pre>
<p><strong>Do not use the <code>root</code> user to run Daiquiri!</strong> It is a bad idea anyway and
several steps of the installation will not work. <code>sudo</code> is used in the
installation when requiring root-privileges to install packages.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Although, most dependencies are installed from the Python Package Index, some
dependecies need to be installed using the operation systems packages manager.
Here we document the minimum prerequisites:</p>
<pre><code># Centos
yum install -y \
    epel-release \
    git \
    gcc gcc-c++ \
    libxml2-devel libxslt-devel \
    openssl-devel \
    python3-devel

# Debian or Ubuntu
apt-get install -y \
    git \
    build-essential \
    libxml2-dev libxslt-dev \
    zlib1g-dev \
    libssl-dev \
    python3-dev \
    python3-venv
</code></pre>
<h2 id="obtaining-the-app-directory">Obtaining the app directory</h2>
<p>The next step is to create the <code>app</code> directory by cloning the corresponding
repository.</p>
<pre><code class="language-bash">git clone https://github.com/django-daiquiri/app
</code></pre>
<p>Note that this is not the main <code>django-daiquiri</code> repository, only the
configuration files. Inside this directory, you will find:</p>
<ul>
<li>a <code>config</code> directory, containing the main settings of your Daiquiri installation,</li>
<li>a <code>manage.py</code> script, which is the main way to interact with your Daiquiri
installation on the command line. Most of the following steps will use this script.</li>
</ul>
<h2 id="install-python-packages">Install Python packages</h2>
<p>After you have obtained the <code>app</code>, you need to install the <code>django-daiquiri</code>
package and the other python dependencies. Change to the <code>app</code> directory and
create a <a href="https://docs.python.org/3/tutorial/venv.html">Virtual Environment</a>
(this is done as your user or the created <code>daiquiri</code> user, not as <code>root</code>):</p>
<pre><code class="language-bash">cd app

python3 -m venv env
source env/bin/activate

pip install --upgrade pip setuptools wheel
</code></pre>
<p>After the virtual environment is activated, the <code>django-daiquiri</code> package
can be installed using <code>pip</code>:</p>
<pre><code class="language-bash">pip install django-daiquiri
</code></pre>
<p>If you want to install the current master branch directly from GutHub,
you alternatively use:</p>
<pre><code class="language-bash">pip install git+https://github.com/django-daiquiri/daiquiri
</code></pre>
<p>The virtual environment encapsulates your Daiquiri installation from the rest
of the system. This makes it possible to run several applications with
different python dependencies on one machine and to install the dependencies
without root permissions.</p>
<p><strong>Important:</strong> The virtual enviroment needs to be activated,
using <code>source env/bin/activate</code> everytime a new terminal is used.
This can be automated using your <code>.bashrc</code>.</p>
<h2 id="basic-setup">Basic setup</h2>
<p>The settings of a Daiquiri application are specified in two files:</p>
<ul>
<li><code>config/settings/base.py</code> should be part of the app repository and holds
the basic settings for this particular site.</li>
<li><code>.env</code> is excluded from the repository and should contain
(possible secret information) about this machine. This file will be different
on the development and the production system.</li>
</ul>
<p>To set up the application, you need to create a new file <code>.env</code> in
your cloned <code>app</code> directory.</p>
<p>You can use <code>.env.sample</code> as template, i.e.:</p>
<pre><code class="language-bash">cp .env.sample .env
</code></pre>
<p>The different settings are explained in detail
<a href="../settings/">later in the documentation</a>. For a minimal configuration,
you need to set</p>
<pre><code class="language-bash">SECRET_KEY=&lt;a secret random string&gt;

SITE_URL=http://localhost:8000

DEBUG=True
ASYNC=False

DATABASE_DEFAULT=postgresql://&lt;user&gt;:&lt;pass&gt;@&lt;host&gt;/&lt;db&gt;
DATABASE_DATA=postgresql://&lt;user&gt;:&lt;pass&gt;@&lt;host&gt;/&lt;db&gt;

FILES_BASE_PATH=files
QUERY_DOWNLOAD_DIR=download
QUERY_UPLOAD_DIR=upload
</code></pre>
<h2 id="databases">Databases</h2>
<p>As mentioned earlier, Daiquiri uses two separate database connections, one for
the web application (<code>default</code>) and one for the scientific data (<code>data</code>).
These database can be on different machines and you can even use MySQL for one
and PostgreSQL for the other. For an SQLite3 database
use <code>sqlite:///database.sqlite3</code> to create the database in the app directory.
For PostgreSQL and peer auth use <code>postgresql://@/&lt;db&gt;</code>.</p>
<p><strong>Note:</strong> The <a href="https://github.com/aipescience/queryparser">queryparser</a> has
dropped the active support of MySQL, thus we strongly recommend to use
PostgreSQL.</p>
<p>In order to use the different database connections, 
install the corresponding package with <code>pip</code>:</p>
<pre><code class="language-bash">pip install psycopg[binary]  # for PostgreSQL
pip install mysqlclient      # for MySQL or MariaDB
</code></pre>
<p><strong>Note:</strong> For the full ADQL support, it is required to install the
<a href="https://github.com/kimakan/pgsphere/tree/aiprdbms16">pg_sphere</a>
extension on the <code>data</code> PostgreSQL database. It is not required for the <code>default</code>
database.</p>
<p>In your virtualenv, you can get the, which you need to perform on your
database with the <code>sqlcreate</code> command:</p>
<pre><code class="language-bash">python manage.py sqlcreate
</code></pre>
<h2 id="initialization">Initialization</h2>
<p>After editing the settings, initialize the application using:</p>
<pre><code class="language-bash">python manage.py migrate                  # initializes the web database
python manage.py migrate --database tap   # initializes the tap schema in the scientific db
python manage.py migrate --database oai   # initializes the oai schema in the scientific db
python manage.py createsuperuser          # creates an admin user
python manage.py download_vendor_files    # dowloads front-end files from the CDN
</code></pre>
<p>After these steps, Daiquiri can be run using Django&rsquo;s intergrated
development server:</p>
<pre><code class="language-bash">python manage.py runserver
</code></pre>
<p>Then, Daiquiri is available on <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>
in your (local) browser.</p>
<h2 id="asyncronous-tasks">Asyncronous tasks</h2>
<p>Several tasks in Daiquiri can make use of asyncronous tasks (e.g. scientic
database queries). Daiquiri can be used without asyncronous tasks, but for any
deployment setup this functionality is recomended. RabbiMQ needs to be
installed for asyncronous tasks to work. For Debian and Ubuntu, RabbitMQ can
be installed from the distribution:</p>
<pre><code class="language-bash">apt-get install rabbitmq-server
</code></pre>
<p>For Centos 7/8, the offical repo needs to be installed as well as its erlang
dependencies. This can be done from <a href="https:packagecloud.io">packagecloud.io</a>:</p>
<pre><code class="language-bash"># see also https://www.rabbitmq.com/install-rpm.html
curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash
curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | sudo bash
yum install rabbitmq-server

systemctl start rabbitmq-server
systemctl enable rabbitmq-server
</code></pre>
<p>The asyncronous tasks can be activated the <code>.env</code> file of your Daiquiri application:</p>
<pre><code class="language-bash">ASYNC=True
</code></pre>
<p>For a more complicated RabbitMQ setup the <code>CELERY_BROKER_URL</code> setting is used as explained <a href="">here</a>.</p>
<p>Daiquiri uses 3 different workers:</p>
<ul>
<li><code>default</code>: For miscanelous database queries performed by users.</li>
<li><code>query</code>: For asynconous database queriesperformed by users.</li>
<li><code>download</code>: For the server-side creation of download files and zip archives.</li>
</ul>
<p>In a development setup these workers can be started using:</p>
<pre><code>python manage.py runworker default
python manage.py runworker query
python manage.py runworker download
</code></pre>
<p>in your virtual app.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../deployment/" class="btn btn-neutral float-right" title="Deployment">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../deployment/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
